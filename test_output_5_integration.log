============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: devtools-0.12.2, langsmith-0.4.59, hypothesis-6.148.7, anyio-4.12.0, cov-7.0.0, logfire-4.16.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 11 items

tests/integration/test_cli_commands.py .EEEE.F                           [ 63%]
tests/integration/test_end_to_end_workflow.py ....                       [100%]

==================================== ERRORS ====================================
_____________________ ERROR at setup of test_init_command ______________________
file /app/tests/integration/test_cli_commands.py, line 82
  def test_init_command(runner, mock_project_manager):
E       fixture 'runner' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, capfire, caplog, capsys, capsysbinary, capteesys, cov, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, insert_assert, insert_assert_add_to_builtins, insert_assert_maybe_fail, insert_assert_session, mock_git_manager, mock_graph_builder, mock_project_manager, mock_session_manager, mock_session_validator, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/integration/test_cli_commands.py:82
__________________ ERROR at setup of test_gen_cycles_command ___________________
file /app/tests/integration/test_cli_commands.py, line 90
  def test_gen_cycles_command(runner, mock_graph_builder, mock_session_manager):
E       fixture 'runner' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, capfire, caplog, capsys, capsysbinary, capteesys, cov, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, insert_assert, insert_assert_add_to_builtins, insert_assert_maybe_fail, insert_assert_session, mock_git_manager, mock_graph_builder, mock_project_manager, mock_session_manager, mock_session_validator, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/integration/test_cli_commands.py:90
___________________ ERROR at setup of test_run_cycle_command ___________________
file /app/tests/integration/test_cli_commands.py, line 106
  def test_run_cycle_command(runner, mock_graph_builder, mock_session_manager, mock_session_validator):
E       fixture 'runner' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, capfire, caplog, capsys, capsysbinary, capteesys, cov, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, insert_assert, insert_assert_add_to_builtins, insert_assert_maybe_fail, insert_assert_session, mock_git_manager, mock_graph_builder, mock_project_manager, mock_session_manager, mock_session_validator, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/integration/test_cli_commands.py:106
_______________ ERROR at setup of test_finalize_session_command ________________
file /app/tests/integration/test_cli_commands.py, line 120
  def test_finalize_session_command(runner, mock_session_manager, mock_git_manager):
E       fixture 'runner' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, capfire, caplog, capsys, capsysbinary, capteesys, cov, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, insert_assert, insert_assert_add_to_builtins, insert_assert_maybe_fail, insert_assert_session, mock_git_manager, mock_graph_builder, mock_project_manager, mock_session_manager, mock_session_validator, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/integration/test_cli_commands.py:120
=================================== FAILURES ===================================
______________________ test_check_environment_all_present ______________________

    def test_check_environment_all_present():
        """Test check_environment passes when all keys present."""
        with (
            patch("ac_cdd_core.utils.check_api_key", return_value=True),
            patch("subprocess.run", return_value=MagicMock(returncode=0)),
        ):
            from ac_cdd_core.cli import check_environment

            # Should not raise
>           check_environment()

tests/integration/test_cli_commands.py:157:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def check_environment() -> None:
        """Checks for required tools and API keys."""
        import os
        import shutil

        from dotenv import load_dotenv

        load_dotenv()

        missing_tools = []
        missing_vars = []

        # 1. Executables
        # Removing 'aider' and 'jules' from local requirements as we aim for fully remote architecture.
        # 'git' and 'uv' are still needed for local project management.
        # 'gh' is optional but recommended for PRs.
        required_tools = ["uv", "git"]
        for tool in required_tools:
            if not shutil.which(tool):
                missing_tools.append(tool)

        # 2. Environment Variables
        # Check strict requirements. Note: OpenRouter is optional if Gemini is used directly,
        # but we should check at least one LLM key.
        # Jules requires JULES_API_KEY.
        required_vars = ["JULES_API_KEY", "E2B_API_KEY"]

        # We need at least one model provider
        if (
            not os.environ.get("GEMINI_API_KEY")
            and not os.environ.get("GOOGLE_API_KEY")
            and not os.environ.get("OPENROUTER_API_KEY")
        ):
            missing_vars.append("GEMINI_API_KEY (or GOOGLE_API_KEY / OPENROUTER_API_KEY)")

        for var in required_vars:
            if not os.environ.get(var):
                missing_vars.append(var)

        if missing_tools or missing_vars:
            console.print(Panel("Environment Check Failed", style="bold red"))

            if missing_tools:
                console.print("[bold red]Missing Executables:[/bold red]")
                for tool in missing_tools:
                    console.print(f"- {tool}")
                console.print(
                    "\n[yellow]Please install these tools and ensure they are in your PATH.[/yellow]\n"
                )

            if missing_vars:
                console.print("[bold red]Missing Environment Variables:[/bold red]")
                for var in missing_vars:
                    console.print(f"- {var}")
                console.print("\n[yellow]Please check your .env file.[/yellow]\n")

            # We don't exit strict here to allow users to fix while running,
            # but we prompt them heavily.
            # Check if running in non-interactive mode (e.g. CI/Test)
            if os.environ.get("NON_INTERACTIVE") or not sys.stdin.isatty():
                 # Fail if missing and non-interactive
>                   sys.exit(1)
E                   SystemExit: 1

dev_src/ac_cdd_core/cli.py:86: SystemExit
----------------------------- Captured stdout call -----------------------------
╭──────────────────────────────────────────────────────────────────────────────╮
│ Environment Check Failed                                                     │
╰──────────────────────────────────────────────────────────────────────────────╯
Missing Environment Variables:
- GEMINI_API_KEY (or GOOGLE_API_KEY / OPENROUTER_API_KEY)
- JULES_API_KEY
- E2B_API_KEY

Please check your .env file.

=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /app/.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                           Stmts   Miss  Cover   Missing
----------------------------------------------------------------------------
dev_src/__init__.py                                0      0   100%
dev_src/ac_cdd_core/__init__.py                    0      0   100%
dev_src/ac_cdd_core/agents.py                     51     51     0%   1-120
dev_src/ac_cdd_core/cli.py                       207    150    28%   44, 68-71, 88-91, 117-119, 133-184, 206-329, 335, 345-414
dev_src/ac_cdd_core/config.py                     23      7    70%   17-21, 29, 35-36
dev_src/ac_cdd_core/contracts/__init__.py          0      0   100%
dev_src/ac_cdd_core/domain_models.py              62      0   100%
dev_src/ac_cdd_core/error_messages.py              8      8     0%   1-18
dev_src/ac_cdd_core/graph.py                     356    324     9%   23-26, 31-36, 43-75, 79-113, 119-137, 146-232, 240-241, 247-264, 274-478, 488-527, 537-692, 702-722, 727-745, 748-813, 818, 822
dev_src/ac_cdd_core/hash_utils.py                 25     22    12%   7-31
dev_src/ac_cdd_core/messages.py                   51     51     0%   4-159
dev_src/ac_cdd_core/presentation.py               25     16    36%   15, 21-34, 45-55
dev_src/ac_cdd_core/process_runner.py             23     18    22%   36-70
dev_src/ac_cdd_core/sandbox.py                   113     96    15%   19-27, 31-64, 73-140, 147-174, 178, 184-208, 212, 215-216
dev_src/ac_cdd_core/service_container.py          14      1    93%   18
dev_src/ac_cdd_core/services/__init__.py           5      0   100%
dev_src/ac_cdd_core/services/artifacts.py         14      8    43%   17-28
dev_src/ac_cdd_core/services/contracts.py         25     20    20%   16-42
dev_src/ac_cdd_core/services/file_ops.py         107     91    15%   31-132, 139-172, 179-201
dev_src/ac_cdd_core/services/git_ops.py          164    141    14%   13-15, 18-22, 30-43, 49-65, 73-83, 89-112, 115, 119, 123, 130-156, 162-170, 176-183, 189-191, 195-196, 205-240, 249-270, 286-305, 311-322, 329-378
dev_src/ac_cdd_core/services/jules_client.py     292    253    13%   38-61, 64-85, 88-89, 92-96, 99-103, 108-111, 114-120, 131-156, 162, 165-180, 197-275, 281-296, 305-321, 327-521, 529-552
dev_src/ac_cdd_core/services/llm_reviewer.py      28     22    21%   14, 28-50, 56-70
dev_src/ac_cdd_core/services/project.py           36     19    47%   17-40, 65
dev_src/ac_cdd_core/session_manager.py           111     86    23%   24-31, 36-44, 49-51, 63-88, 98-135, 147-148, 170-195, 212-270
dev_src/ac_cdd_core/state.py                      52      8    85%   66-72, 78-84
dev_src/ac_cdd_core/tools.py                      31     31     0%   1-65
dev_src/ac_cdd_core/tools_fs.py                    9      9     0%   1-15
dev_src/ac_cdd_core/utils.py                      28     19    32%   25-49, 57-72
dev_src/ac_cdd_core/validators.py                 38     38     0%   2-76
----------------------------------------------------------------------------
TOTAL                                           1898   1489    22%
=========================== short test summary info ============================
FAILED tests/integration/test_cli_commands.py::test_check_environment_all_present
ERROR tests/integration/test_cli_commands.py::test_init_command
ERROR tests/integration/test_cli_commands.py::test_gen_cycles_command
ERROR tests/integration/test_cli_commands.py::test_run_cycle_command
ERROR tests/integration/test_cli_commands.py::test_finalize_session_command
============== 1 failed, 6 passed, 1 warning, 4 errors in 12.25s ===============
