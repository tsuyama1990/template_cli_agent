機械学習ポテンシャル自動生成・解析パイプライン (MLIP-AutoPipe) システム仕様書Version: 1.8.0Status: Draft (Rigorous Physics & Implementation Details Added)Target Audience: System Architects, Backend Engineers, Computational Materials Scientists1. イントロダクション1.1 背景と目的従来の原子スケールシミュレーション、特に第一原理計算（DFT）やそれを用いた第一原理分子動力学（AIMD）は、物質科学における強力なツールである一方で、その運用には高度な専門知識と膨大な計算リソースが必要です。現状では、学習データの生成において「どの温度・圧力条件で、どのような原子配置を計算すべきか」という判断は、経験豊富な研究者の直感や暗黙知に大きく依存しています。この属人性こそが、機械学習ポテンシャル（MLIP）構築の自動化を阻む最大のボトルネックとなっていました。本システムは、「人間（Expert）をループから排除する（removing the human expert from the loop）」 ことを設計思想の中核に据えます。物理則に基づくヒューリスティック（経験則のアルゴリズム化）と、機械学習モデル自身による不確実性定量化（Uncertainty Quantification）を組み合わせることで、初期構造生成から能動学習（Active Learning）、そして長時間スケールシミュレーション（kMC/MD）までを完全自動化するパイプラインを提供します。これにより、ユーザーは物質名と組成を入力するだけで、第一原理精度を持つポテンシャルを自律的に獲得し、複雑な相変態や反応ダイナミクスといった現象の解明に注力できる環境を実現します。1.2 スコープ本システムは以下の機能を包含し、従来の「AIMDに依存した非効率な学習」からの脱却と、計算コストの大幅な削減を目指します。物理的妥当性のある初期構造の自動生成: 合金、分子、イオン結晶、共有結合結晶の各特性に合わせ、高コストなAIMDを使わずに多様かつ物理的に妥当な原子配置を生成する手法（SQS, NMS, AIRSS等）を実装します。汎用ポテンシャル (MACE) を用いた探索とDIRECTサンプリング: 既知の大規模データセットで学習された最新の基盤モデルである MACE (MACE-MP) を標準採用し、DFT計算なしで広範な位相空間を高速にスキャンする機能を提供します。これにより、DFT計算資源を「真に情報価値の高い構造」に集中させます。Quantum Espresso (QE) による全自動ラベリング: 収束パラメータ（k点、スメアリング等）や擬ポテンシャル設定を自動最適化し、専門家の介在なしに高精度かつロバストなForce/Stress/Energis挙動（近距離での斥力項など）を保証するために、参照ポテンシャル（LJ/ZBL）との残差学習を行うトレーニングパイプラインを整備します。On-the-fly (OTF) での推論と不確実性に基づく再学習: シミュレーション中にモデルが未知の領域（外挿領域）に踏み込んだことを検知し、その局所構造を切り出して再学習を行う自律的な改善ループ（Active Learning Loop）を実装します。長時間スケールの探索的シミュレーション (kMC/MD): レアイベント（拡散、反応）を効率的に探索するためのAdaptive kMCおよび探索的MDを実装し、ナノ秒からマイクロ秒、あるいはそれ以上の時間スケールでの現象解析を可能にします。2. システムアーキテクチャシステムは以下の5つの主要モジュールと、それらを統括する Workflow Orchestrator で構成されます。データの永続化とトレーサビリティの確保には ASE Database (SQLite/PostgreSQL) 等のモダンなデータベースインターフェースを使用し、すべての計算工程を記録します。2.1 環境構築と依存ソフトウェア管理本パイプラインは、レガシーな管理手法を廃し、モダンなPythonエコシステムと高速なツールチェーン、そして積極的なJITコンパイルによる数値計算最適化を全面的に採用します。Python環境と依存管理 (pyproject.toml & uv):プロジェクトの依存関係定義は、PEP 621に準拠した pyproject.toml に一元化します。パッケージ管理および仮想環境の構築には、Rust製の高速パッケージマネージャである uv を採用します。これにより、環境構築の再現性と速度を最大化します。計算高速化ライブラリ (High-Performance Computing Tools):Pythonの動的型付けに起因するオーバーヘッドを排除するため、Numba を積極的に導入します。特に、純粋なPythonで記述されるカスタムロジック（近接原子リストの構築、kMCのレート計算ループ、独自の記述子計算など）に対しては、@jit(nopython=True) デコレータを適用し、C/C++並みの実行速度を確保します。大規模な行列演算や自動微分が必要な箇所については、必要に応じて JAX の導入も検討し、ハードウェア（CPU/GPU）の性能を限界まで引き出します。Quantum Espresso (User Provided):DFTエンジンとして pw.x を使用します。ユーザーは設定ファイル内で並列実行コマンド（mpirun等）や並列数（デフォルト: 4コア）を指定するだけでよく、システムは指定されたパスの pw.x を呼び出します。LAMMPS & MLIP Extensions (Auto Build):MDおよびkMCエンジンとなる LAMMPS は、最新のMLポテンシャル（ACE等）や長期ダイナミクス拡張（EON等）との連携に必要なパッチやライブラリを含む必要があるため、システムセットアップ時に自動的にリポジトリからソースコードをダウンロードし、ビルドを行います。2.2 モジュール構成各モジュールは疎結合に設計し、将来的に新しいアルゴリズムやライブラリが登場した際にも容易に交換可能なアーキテクチャとします。Module A: Structure Generator (Initial Seeding) - 物理的ヒューリスティックに基づき、DFTを使わずに静的な初期構造を生成するモジュール。Module B: Explorer & Sampler (DIRECT & Active Learning) - MACE をサロゲートモデルとして利用し、広域探索と情報理論に基づくサンプリングを行うモジュール。Module C: Labeling Engine (Automated DFT) - ロバストな自動DFT計算実行部。Module D: Training Engine (Delta Learning) - 残差学習を取り入れたMLIP学習部。Module E: Simulation Engine (OTF MD/kMC) - 不確実性監視機能付きの動力学シミュレーション実行部。3. 機能要件詳細3.1 Module A: Structure Generator (Initial Seeding)目的: ユーザーの最小限の入力から、物理的に妥当かつ多様性に富んだ初期学習データを生成します。要件:REQ-A-01 インプット解析とボンドタイプ判定:想定インプット:組成文字列 (例: "Fe2O3"): 構造未知の場合。初期構造ファイル (CIF/POSCAR等): 構造既知の場合。ボンドタイプ自動判定: 最新の材料解析ライブラリ（pymatgen, ase等）を活用し、電気陰性度、原子半径、トポロジー解析に基づいて、系を Alloy (合金), Molecule (分子), Ionic (イオン性), Covalent (共有結合) の4タイプに自動分類します。REQ-A-02 合金: 高速SQS生成と歪み印加:SQS (Special Quasirandom Structures): 有限スーパーセル内でランダム合金の相関関数を模倣します。最適化: SQS生成におけるモンテカルロ探索の評価関数（クラスター相関関数の計算）は計算負荷が高いため、icet などの既存ツールを利用しつつ、カスタム評価が必要な場合は Numba で高速化した目的関数を使用します。拡張: ターゲット組成だけでなく、意図的な組成変動（Off-stoichiometry）や格子歪み（Volume/Shear deformation）を加えた構造セットを生成し、化学ポテンシャル勾配や弾性特性を学習データに含めます。Implementation Note (Supercell Size): 計算コストと精度のバランスを取るため、SQSのサイズは 32〜96原子 の範囲をターゲットとして自動決定します。これ以下では相関関数の再現性が低く、これ以上ではDFTコストが過大になります。REQ-A-03 分子: Normal Mode Sampling (NMS):タイプがMoleculeの場合、基準振動モードに基づく Normal Mode Sampling (NMS) を実行します。Hessian行列の対角化とモード変位ベクトルの生成処理を最適化し、数千原子規模の系でも迅速に初期構造セットを生成できるようにします。高周波振動モードを含む多様な歪み構造を生成し、結合解離や振動スペクトルの記述精度を向上させます。REQ-A-04 イオン性: AIRSS & Polymorphs:タイプがIonicの場合、Ab Initio Random Structure Searching (AIRSS) 相当のランダム構造探索を行います。イオン半径と静電相互作用を考慮した配置を行い、後述のサロゲートモデルで事前緩和することで、安定相および準安定相（多形）を効率的に収集します。REQ-A-05 共有結合: Deep Rattling & Melt-Quench:タイプがCovalentの場合、原子位置に大きなランダムノイズを加える "Deep Rattling" や、サロゲートモデルを用いた Melt-Quench（溶融急冷） プロトコルを実行します。急冷プロセスのMD実行自体も、後述の高速サロゲートモデルを用いて行い、トポロジー的に多様なアモルファス/欠陥構造を生成します。3.2 Module B: Explorer & Sampler (Performance Critical)目的: DFTを使わずに広範な位相空間を探索し、学習効果の高い構造を選別します。ここは扱うデータ量が膨大になるため、計算効率が最重要視されます。要件:REQ-B-01 Universal Potential Surrogate (MACE Standard):初期探索および構造生成時の事前緩和には、MACE (MACE-MP-0 model) を標準サロゲートモデルとして使用します。GPUアクセラレーション: 探索フェーズにおいて、PyTorchバックエンドを活用し、自動的にGPU上で高速推論を実行します。REQ-B-02 DIRECT Sampling Optimized with Numba:MACEを用いて、高温・高圧条件下での大規模MDトラジェクトリ（数百万フレーム）を生成します。記述子の整合性: クラスタリングに用いる記述子は、最終的な学習モデル（ACE等）が捉える物理量と相関があるべきです。ここでは計算速度と物理的表現力を両立するため、SOAP記述子またはACE記述子を標準として使用します（MACEの内部embeddingは次元数が高く扱いづらいため推奨しません）。高速記述子計算: 既存ライブラリがボトルネックとなる場合は、Numba を用いて並列化・ベクトル化したカスタムカーネルを実装します。層化サンプリング: クラスタリング結果に基づき、平衡状態から遷移状態までをバランスよく抽出する層化サンプリング（Stratified Sampling）を適用し、バイアスのない学習データセットを構築します。3.3 Module C: Labeling Engine (Automated DFT)目的: 専門知識なしでQuantum Espresso (QE) を実行し、高品質なラベルを取得します。要件:REQ-C-01 Parameter Automation:SSSP Protocol: 擬ポテンシャルおよびCutoff設定には、標準的な高精度プロトコル（SSSP Precision等）を自動適用します。Robust Settings: k点メッシュの自動密度設定や、SCF収束を安定させるためのSmearing（Gaussian/Marzari-Vanderbilt）およびMixingパラメータの自動調整を行います。REQ-C-02 Static Calculation Config:学習用データとして、構造最適化（Relaxation）を行わない固定点計算（Single Point Calculation）を実行し、原子にかかる力（Force）と応力（Stress）を出力します。精度の高いForceを取得するため、SCFの収束条件を厳格化します。REQ-C-03 Provenance & Error Recovery:高度なSCFリカバリ: 単にMixing Betaを下げるだけでなく、以下の順序で自動リカバリを試行します。Mixing Betaの低減 (0.7 -> 0.3)Mixing Modeの変更 (Broyden -> Local-TF)Smearing温度（degauss）の一時的な上昇（収束後に元の温度で再計算）対角化アルゴリズムの変更 (Davidson -> Conjugate Gradient)REQ-C-04 Advanced Magnetism & SOC Handling (Crucial):FePtのような磁性材料において、磁気構造の扱いは精度の生命線です。Magnetic Initialization Strategy: ユーザー指定がない場合、まず「強磁性 (Ferromagnetic)」で初期化します。収束しない場合、またはエネルギー的に不安定な場合、自動的にランダムなスピン配置（Disordered AFM）または反強磁性配置を試行するロジックを実装します。SOC (Spin-Orbit Coupling): スピン軌道相互作用は計算コストが非常に高いため（Non-collinear計算が必要）、学習の初期フェーズ（Phase 1-2）では Scalar Relativistic (SR) で計算を行います。最終的な精度向上フェーズ（Phase 3のRefinement）においてのみ、Config設定により SOC を有効化して再計算・ファインチューニングを行う「2段階学習」をサポートします。3.4 Module D: Training Engine (Delta Learning)目的: 物理的制約を取り入れたロバストなMLポテンシャルを学習させます。要件:REQ-D-01 Delta Learning Base:物理ベースの参照ポテンシャル（Reference Potential）とDFT計算値との差分（残差）を学習する Delta Learning を採用します。REQ-D-02 Automated Physics Baselines:参照ポテンシャルのパラメータ（LJの$\sigma, \epsilon$等）が不明な場合、原子半径や分極率などの物理定数から自動推定するロジックを組み込みます。REQ-D-03 Training Framework & Hyperparameter Optimization:学習エンジンには、ACE (Pacemaker) を採用します。HPO (Hyperparameter Optimization): ACEの性能を左右する「基底関数の最大次数 (Body Order, default: 3-4)」や「多項式の次数 (Polynomial Degree, default: 12-16)」は、固定値ではなく、初期の小規模データセットを用いた簡易的なグリッドサーチで最適値を推定してから本学習に入ります。Loss Weights: エネルギー($E$)、力($F$)、応力($S$)の損失関数の重みは、経験的にロバストな $E:F:S = 1 : 100 : 10$ をデフォルトとし、必要に応じて調整します。3.5 Module E: Simulation Engine (OTF & kMC)目的: 学習したポテンシャルを用いて、長時間・大規模な現象を探索し、能動学習ループを回します。要件:REQ-E-01 On-the-fly (OTF) Inference Loop & Dynamic Threshold:Dynamic Uncertainty Threshold: 不確実性閾値 ($\gamma_{threshold}$) を固定値（例: 5.0）にする運用は危険です。モデルの成熟度に応じて閾値を動的に調整するため、直近の学習データセットに対する $\gamma$ の分布を計算し、その 95%〜99%タイル点 を新たな閾値として動的に設定するロジックを実装します。これにより、学習初期は緩く、成熟後は厳しく判定することが可能になります。REQ-E-02 Periodic Embedding & Boundary Treatment (Advanced):単純なクラスター切り出しでは、共有結合の切断（ダングリングボンド）やイオン結晶における電荷不均衡が深刻なアーティファクトを引き起こすため、以下の高度な境界処理を自動適用します。Buffer Region & Constrained Relaxation: 学習対象となる中心領域（Core）の周囲に十分な厚みのバッファ層（Buffer）を設けます。DFT計算前に、バッファ層の原子のみをMACE等で簡易緩和（Constrained Relaxation）させ、構造的な歪みを軽減します。Force Masking: 学習時には、境界の影響を受けるバッファ層のForce/Stressを完全にマスク（除外）し、物理的に信頼できる中心領域のデータのみを教師データとします。Boundary Passivation (Covalent): 共有結合性結晶の場合、切断されたボンドを検出し、水素原子等による**終端処理（Passivation）**を自動的に行います。Charge Neutrality (Ionic): イオン結晶の場合、切り出したセル全体の総電荷が中性（Neutral）になるよう、対イオンの追加・削除を行うか、あるいは一様なバックグラウンド電荷（Jellium Background）による補正を適用します。REQ-E-03 Advanced Sampling Integration (Tiered kMC Rates):Tiered Rate Calculation: kMCにおける遷移確率は $k = \nu \exp(-E_a/k_BT)$ で決まりますが、頻度因子 $\nu$ の計算（Hessian計算）は非常に重いです。これを解決するため、階層的レート計算 (Tiered Approach) を導入します。Tier 1 (Screening): 全てのイベント候補に対し、固定の頻度因子（例: $\nu = 10^{12} \text{Hz}$）を用いてレートを概算し、発生確率の高いイベントを絞り込みます。Tier 2 (Refinement): 選ばれた上位のイベントに対してのみ、実際にHessianを計算（またはMLモデルで予測）して $\nu$ を精密化します。このロジックにより、計算コストを抑えつつ物理的な正確さを担保します。kMCステップ自体は Numba で高速化します。4. ワークフロー制御とUI仕様4.1 設定ファイル設計: Two-Tier Configuration Strategyユーザビリティと柔軟性を両立し、かつ「人間をループから排除する」という設計思想を具現化するために、設定ファイルは**「入力用（Minimal）」と「実行用（Full）」の2段階（Two-Tier）**で管理する戦略を採用します。※以下の設定ファイルは一例です。ここでは、L1_0型規則合金の代表例であり、その高い結晶磁気異方性から次世代の高密度磁気記録材料として重要視されている FePt（鉄白金） を解析ターゲットとしたケースを示しています。本システムはこの組成に限らず、任意の元素・組成に対応します。Minimal Config (input.yaml):ユーザーが作成するファイル。物質情報と最低限の目的（温度範囲など）のみを記述します。デフォルト値で良い部分は記述不要とし、参入障壁を下げます。Config Expander (Heuristic Engine):システムは input.yaml を読み込むと、内蔵された物理ヒューリスティックエンジンを起動します。物質解析: 組成から結合タイプを判定。パラメータ推論: SSSPプロトコルに基づいたDFTカットオフ、ハードウェアリソースに応じた並列数、物質の融点予測に基づくMD温度ステップなどを自動決定します。サロゲート設定: 探索用モデルとして MACE-MP を自動割り当てします。Full Config (exec_config_dump.yaml):ヒューリスティックエンジンによって全パラメータが埋められた完全な設定ファイルです。実際のシミュレーションはこのファイルに基づいて実行されます。設定ファイル例 (Target: FePt - Magnetic Material Benchmark)A. Minimal Config (input.yaml - User Provided)system:
  elements: ["Fe", "Pt"]
  composition: "FePt" # 例: L10型規則合金の探索を想定

simulation:
  temperature: [300, 1000] # この範囲でポテンシャルを作りたい

B. Full Config (exec_config_dump.yaml - System Generated)# AUTO-GENERATED FULL CONFIGURATION (EXAMPLE)
system:
  elements: ["Fe", "Pt"]
  composition: {"Fe": 0.5, "Pt": 0.5}
  structure_type: "alloy" # Heuristic: Detected as Alloy
  melting_point_guess: 1500 # Heuristic: Guess from phase diagram data

simulation:
  temperature_steps: [300, 650, 1000] # Interpolated steps
  pressure: 0
  active_learning:
    strategy: "direct_then_active"
    surrogate_model: "mace_mp" # Standardized to MACE
    max_generations: 10
    uncertainty_threshold: "dynamic_95percentile" # Dynamic Threshold
    md_steps_per_generation: 10000

dft_compute:
  code: "quantum_espresso"
  command: "mpirun -np 32 pw.x" # Auto-detected CPU cores
  pseudopotentials: "SSSP_1.3_PBE_precision" # Auto-selected protocol
  ecutwfc: 90.0 # Ry (Determined by max(Fe, Pt) in SSSP)
  ecutrho: 720.0 # Ry
  kpoints_density: 0.15 # 1/A
  smearing: "mv"
  degauss: 0.02
  magnetism: "ferromagnetic" # Heuristic: Fe detected
  soc_enabled: False # Phase 1-2: False, Phase 3: True (Refinement)
  recovery_strategy: "aggressive" # Enable advanced recovery logic

mlip_training:
  model_type: "ace"
  r_cut: 5.5 # Angstrom (Heuristic based on atomic radii)
  delta_learning: True
  base_potential: "lj_auto"
  loss_weights: {energy: 1.0, force: 100.0, stress: 10.0}
  ace_params: {body_order: "auto", polynomial_degree: "auto"} # Auto-tune

4.2 実行フロー詳細Initialize & Expansion:uv run mlip-pipe input.yaml を実行。システムは input.yaml を解析し、ヒューリスティックを用いて exec_config_dump.yaml を生成・保存。Surrogate Search:Full Configに基づき、Module Bで基盤モデル (MACE-MP) を用いた高速探索。Numbaで最適化された記述子計算により、候補構造を選定。Initial Labeling:選定された構造に対し、Module C (QE) がFull Configのパラメータ（自動設定されたCutoff等）で計算を実行。磁性体の場合、まずは強磁性で計算し、失敗時は自動リカバリ（スピンフリップ等）を試行。Initial Training:Module D によるDelta Learning。ACEのハイパーパラメータを自動チューニング。OTF Loop:Module Eでシミュレーション実行 -> 不確実性検知（動的閾値） -> 構造抽出（Periodic Embedding + Passivation） -> QE計算 -> 再学習。kMC等のイベント探索ループではJITコンパイルされたカーネルと階層的レート計算を使用し、高速かつ正確に時間発展させます。5. 実装ロードマップPhase 1 (Core): QE自動化(Module C)と学習エンジン(Module D)の連携。pyproject.toml ベースのモダンなプロジェクト構成の確立。Phase 2 (Generation & Expansion): SQS, NMS等の初期構造生成(Module A)の実装。Config Expander (Heuristic Engine) の開発（MinimalからFullへの変換ロジック）。uv による環境構築の整備。Phase 3 (Optimization): DIRECTサンプリング(Module B)とNumbaを用いたボトルネック関数の最適化。MACE-MPの統合。Phase 4 (OTF): LAMMPS/kMC(Module E)のビルド・統合と能動学習ループの実装。kMCエンジンの高速化チューニング（階層的レート計算の実装）。Phase 5 (UI): ユーザーインターフェースの実装とドキュメント整備。