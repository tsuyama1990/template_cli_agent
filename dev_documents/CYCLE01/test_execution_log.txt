============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: devtools-0.12.2, langsmith-0.4.59, mock-3.15.1, hypothesis-6.148.7, anyio-4.12.0, cov-7.0.0, logfire-4.16.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 40 items

tests/unit/data/test_database.py ......                                  [ 15%]
tests/unit/data/test_models.py ...                                       [ 22%]
tests/unit/modules/test_c_labeling_engine.py ...                         [ 30%]
tests/unit/modules/test_d_training_engine.py .F..                        [ 40%]
tests/unit/test_data.py ..........                                       [ 65%]
tests/unit/test_orchestrator.py ....                                     [ 75%]
tests/unit/test_training_engine.py .                                     [ 77%]
tests/unit/utils/test_dft_utils.py ......                                [ 92%]
tests/e2e/test_cycle01_workflow.py ...                                   [100%]

=================================== FAILURES ===================================
_______________ test_training_engine_with_delta_data_preparation _______________

mock_lj = <MagicMock name='LennardJones' id='139723828935376'>
training_config_with_delta = MLIPTraining(model_type='ace', r_cut=5.0, delta_learning=True, base_potential='lj_auto', loss_weights={'energy': 1.0, 'forces': 1.0})
labeled_atoms_list = [Atoms(symbols='H', pbc=False, calculator=SinglePointCalculator(...)), Atoms(symbols='H', pbc=False, calculator=SinglePointCalculator(...))]

    @patch('ase.calculators.lj.LennardJones')
    def test_training_engine_with_delta_data_preparation(
        mock_lj, training_config_with_delta, labeled_atoms_list
    ):
        """Test the data preparation step of the engine with delta learning."""
        mock_lj_instance = mock_lj.return_value
        mock_lj_instance.get_potential_energy.side_effect = [-0.5, -0.8]
        mock_lj_instance.get_forces.side_effect = [
            np.array([[0.05, 0.05, 0.05]]),
            np.array([[0.1, 0.1, 0.1]])
        ]

        engine = TrainingEngine(training_config_with_delta)
        prepared_data = engine._prepare_training_data(labeled_atoms_list)

>       assert prepared_data[0].get_potential_energy() == pytest.approx(-0.5)
E       assert np.float64(-1.0) == -0.5 ± 5.0e-07
E
E         comparison failed
E         Obtained: -1.0
E         Expected: -0.5 ± 5.0e-07

tests/unit/modules/test_d_training_engine.py:72: AssertionError
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/e3nn/o3/_wigner.py:10
  /app/.venv/lib/python3.12/site-packages/e3nn/o3/_wigner.py:10: UserWarning: Environment variable TORCH_FORCE_NO_WEIGHTS_ONLY_LOAD detected, since the`weights_only` argument was not explicitly passed to `torch.load`, forcing weights_only=False.
    _Jd, _W3j_flat, _W3j_indices = torch.load(os.path.join(os.path.dirname(__file__), 'constants.pt'))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                 Stmts   Miss  Cover   Missing
----------------------------------------------------------------------------------
dev_src/__init__.py                                      0      0   100%
dev_src/ac_cdd_core/__init__.py                          0      0   100%
dev_src/ac_cdd_core/agents.py                           49     49     0%   1-110
dev_src/ac_cdd_core/cli.py                             271    271     0%   1-569
dev_src/ac_cdd_core/config.py                           23     23     0%   1-40
dev_src/ac_cdd_core/contracts/__init__.py                0      0   100%
dev_src/ac_cdd_core/domain_models.py                    67     67     0%   1-129
dev_src/ac_cdd_core/error_messages.py                    7      7     0%   4-18
dev_src/ac_cdd_core/graph.py                           365    365     0%   1-840
dev_src/ac_cdd_core/hash_utils.py                       25     25     0%   1-31
dev_src/ac_cdd_core/messages.py                         51     51     0%   4-157
dev_src/ac_cdd_core/process_runner.py                   23     23     0%   1-70
dev_src/ac_cdd_core/sandbox.py                         116    116     0%   1-225
dev_src/ac_cdd_core/service_container.py                18     18     0%   1-22
dev_src/ac_cdd_core/services/__init__.py                 5      5     0%   1-6
dev_src/ac_cdd_core/services/artifacts.py               14     14     0%   1-28
dev_src/ac_cdd_core/services/audit_orchestrator.py      62     62     0%   1-146
dev_src/ac_cdd_core/services/contracts.py               25     25     0%   1-42
dev_src/ac_cdd_core/services/file_ops.py               107    107     0%   1-201
dev_src/ac_cdd_core/services/git_ops.py                172    172     0%   1-399
dev_src/ac_cdd_core/services/jules_client.py           378    378     0%   1-724
dev_src/ac_cdd_core/services/llm_reviewer.py            28     28     0%   1-70
dev_src/ac_cdd_core/services/plan_auditor.py            25     25     0%   1-69
dev_src/ac_cdd_core/services/project.py                 32     32     0%   1-63
dev_src/ac_cdd_core/session_manager.py                 135    135     0%   3-309
dev_src/ac_cdd_core/state.py                            52     52     0%   1-88
dev_src/ac_cdd_core/tools.py                            31     31     0%   1-65
dev_src/ac_cdd_core/utils.py                            54     54     0%   1-149
dev_src/ac_cdd_core/validators.py                       38     38     0%   3-76
src/mlip_autopipec/__init__.py                           0      0   100%
src/mlip_autopipec/cli.py                               22      4    82%   32-34, 40
src/mlip_autopipec/config.py                            16      1    94%   25
src/mlip_autopipec/data/__init__.py                      0      0   100%
src/mlip_autopipec/data/database.py                     40      0   100%
src/mlip_autopipec/data/models.py                       43      0   100%
src/mlip_autopipec/modules/__init__.py                   0      0   100%
src/mlip_autopipec/modules/c_labeling_engine.py         70     13    81%   44-45, 71-73, 84-86, 100-104, 117-119
src/mlip_autopipec/modules/d_training_engine.py         62      1    98%   86
src/mlip_autopipec/orchestrator.py                      33      0   100%
src/mlip_autopipec/utils/__init__.py                     0      0   100%
src/mlip_autopipec/utils/dft_utils.py                   54      3    94%   78-79, 111
src/mlip_autopipec/workflow.py                          17      3    82%   38-44
----------------------------------------------------------------------------------
TOTAL                                                 2530   2198    13%
=========================== short test summary info ============================
FAILED tests/unit/modules/test_d_training_engine.py::test_training_engine_with_delta_data_preparation
=================== 1 failed, 39 passed, 1 warning in 17.31s ===================
