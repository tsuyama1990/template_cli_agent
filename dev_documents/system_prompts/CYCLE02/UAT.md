# Cycle 2 User Acceptance Testing (UAT): Foundational Exploration Engine

This document outlines the User Acceptance Testing (UAT) for Cycle 2. The focus of this cycle was the implementation of the foundational Molecular Dynamics (MD) exploration engine. This UAT is designed for a user to verify that the system can now take a set of initial structures, run MD simulations on them in parallel using a real Machine Learning Interatomic Potential (MLIP), and correctly record the results.

## 1. Test Scenarios

As in the previous cycle, the UAT will be conducted via a Jupyter Notebook (`UAT_Cycle2.ipynb`). This provides an interactive environment to run the pipeline, inspect the output files, and query the database, offering clear and verifiable proof that the new exploration functionality is working correctly.

| Scenario ID | Scenario Name                               | Priority |
|-------------|---------------------------------------------|----------|
| UAT-C2-01   | Successful Execution of the Exploration Stage | High     |
| UAT-C2-02   | Verification of Trajectory Output Files       | High     |
| UAT-C2-03   | Verification of Database State After Exploration | High     |

### UAT-C2-01: Successful Execution of the Exploration Stage

**Description:**
This scenario is the primary "happy path" test for Cycle 2. The user will configure and run the full pipeline, including the new exploration stage. The goal is to confirm that the system can execute the MD simulations in parallel without crashing and that the overall process completes successfully. This test validates the integration of the `ExplorationEngine`, the MACE calculator, and the parallel processing logic.

**Execution via Jupyter Notebook (`UAT_Cycle2.ipynb`):**
1.  **Setup:** A code cell will create a `config_cycle2.yaml` file. This configuration will be set up to be quick to run for testing purposes:
    *   `generator`: Generate a small number of structures (e.g., 4).
    *   `exploration`: Enable this stage. Set a moderate temperature (e.g., 500 K), a very small number of MD steps (e.g., 20), and specify a small, fast-to-load MACE model.
    *   `db_path`: `cycle2_test.db`.
2.  **Execution:** The next cell will run the pipeline using the command `!mlip-autopipec --config config_cycle2.yaml`. The user should observe the output, which may include logs from the parallel workers.
3.  **Verification:** The user will check that the command finishes with a success message and without any stack traces or errors. A final code cell will confirm the existence of the `cycle2_test.db` file and a new directory (e.g., `trajectories/`) containing the output files, providing a clear "PASSED" or "FAILED" message.

### UAT-C2-02: Verification of Trajectory Output Files

**Description:**
This scenario ensures that the MD simulations are not just running, but are producing scientifically plausible and correctly formatted output. The user will inspect the trajectory files generated by the exploration stage to confirm they contain the expected data.

**Execution via Jupyter Notebook (`UAT_Cycle2.ipynb`):**
This test builds on the successful run from UAT-C2-01.
1.  **File Discovery:** A code cell will list the contents of the `trajectories/` directory to show the output files that were created (e.g., `md_run_1.traj`, `md_run_2.traj`, etc.).
2.  **Trajectory Inspection:** The user will use the `ase.io.read` function in a code cell to load one of the trajectory files into a list of `ase.Atoms` objects.
3.  **Verification:** The user will perform several checks on the loaded trajectory data:
    *   **Frame Count:** Assert that the number of frames in the trajectory matches the number of logging steps (which is related to `num_steps` in the configuration). For 20 steps, we might expect 2-3 frames depending on the logging frequency.
    *   **Atomic Motion:** The user will compare the atomic positions of the first frame and the last frame. A code cell will calculate the total displacement and assert that it is greater than zero, providing programmatic proof that the atoms have moved.
    *   **Energy and Forces:** The user will inspect the last `atoms` object in the trajectory and confirm that it has energy and forces attached, which are calculated by the MACE model.
    *   **Visualization:** A final cell will use `nglview` to create an animation of the trajectory, giving the user direct visual confirmation of the atoms moving during the simulation.

### UAT-C2-03: Verification of Database State After Exploration

**Description:**
This scenario verifies that the `AseDBWrapper` and `ExplorationEngine` are correctly communicating and that the database is being updated properly to reflect the results of the exploration stage. This is crucial for the pipeline's state management and restartability.

**Execution via Jupyter Notebook (`UAT_Cycle2.ipynb`):**
This test also builds on the successful run from UAT-C2-01.
1.  **Database Connection:** A code cell will connect to the `cycle2_test.db` using `ase.db.connect`.
2.  **Metadata Verification:** The user will retrieve all the rows from the database. A code cell will then iterate through each row and perform assertions:
    *   Check that every row now contains a `key_value_pairs` dictionary.
    *   Assert that within this dictionary, a key named `trajectory_path` exists for every single structure.
    *   Assert that the value associated with `trajectory_path` is a string that corresponds to an actual file path that was created during the run.
3.  **Restartability Check:** The user will re-run the `!mlip-autopipec --config config_cycle2.yaml` command in a new cell. Because the database now records that all structures have been explored, the exploration engine should find no work to do. The user will verify that the command finishes almost instantly and that the log output indicates that 0 new simulations were started. This confirms the state management is working correctly.

## 2. Behavior Definitions

**Scenario: Successful Execution of the Exploration Stage**

*   **GIVEN** a valid YAML configuration file `config_cycle2.yaml` that enables the `exploration` stage for 4 structures.
*   **WHEN** the user executes the command `mlip-autopipec --config config_cycle2.yaml`.
*   **THEN** the command should execute successfully, potentially showing logs from multiple parallel processes.
*   **AND** the final output should be a success message.
*   **AND** a database file `cycle2_test.db` should be created.
*   **AND** a `trajectories` directory (or similar) should be created, containing 4 trajectory output files.

**Scenario: Verification of Trajectory Output Files**

*   **GIVEN** the exploration pipeline has been successfully run.
*   **AND** a trajectory file (e.g., `trajectories/md_run_1.traj`) has been generated.
*   **WHEN** a user reads this file using `ase.io.read(..., index=":")`.
*   **THEN** the result should be a list of `ase.Atoms` objects, with a length greater than 1.
*   **AND** the atomic positions of the last `Atoms` object in the list should be different from the positions in the first `Atoms` object.
*   **AND** the last `Atoms` object in the list must have associated energy and forces data.

**Scenario: Verification of Database State After Exploration**

*   **GIVEN** the full generation and exploration pipeline has completed successfully.
*   **WHEN** a user connects to the output database `cycle2_test.db`.
*   **THEN** a query for all structures should return 4 rows.
*   **AND** every row returned must contain a key-value pair with the key `trajectory_path`.
*   **AND** when the pipeline is executed a second time with the same configuration file, it should complete much faster and the logs should indicate that zero new exploration tasks were run.
