# Cycle 03 User Acceptance Testing (UAT)

This document outlines the User Acceptance Testing scenarios for Cycle 03 of the MLIP-AutoPipe project. The focus of this cycle is the implementation of the `Explorer & Sampler` module, which uses a surrogate MACE model for large-scale exploration and an intelligent DIRECT sampling algorithm to select the most informative structures for DFT labelling. The user acceptance criteria for this cycle revolve around verifying that this new module not only works but also delivers on its primary promise: a more efficient and intelligent data acquisition process.

## 1. Test Scenarios

| Scenario ID | Scenario Name                                      | Priority |
| :---------- | :------------------------------------------------- | :------- |
| UAT-C03-01  | Successful Filtering of Structures via MACE MD     | High     |
| UAT-C03-02  | Verification of Descriptor and Sampling Logic      | High     |
| UAT-C03-03  | Performance of Descriptor Calculation Step         | Medium   |

---

### **Scenario UAT-C03-01: Successful Filtering of Structures via MACE MD**

**Description (Min 300 words):**
This is the primary user-facing scenario for Cycle 03. Its purpose is to verify that the new `Explorer & Sampler` module is correctly integrated into the pipeline and successfully achieves its main goal: reducing the number of expensive DFT calculations required to build a potential. The user will start with a minimal configuration, similar to Cycle 02. The configuration will now be extended to include parameters for the exploration phase, such as the number of MD steps to run with the surrogate model and the final, much smaller, number of samples to select for high-fidelity labelling. For example, the user might configure the system to run 1,000 MD steps from each of 5 initial seeds (totaling 5,000 candidate frames) but specify that only 20 final structures should be selected for labelling.

When the pipeline is executed, it should first generate the initial seed structures as before. Then, the new module should be invoked. The user should be able to see from the console logs that the system is running a molecular dynamics simulation using the fast MACE model. After the MD run completes, the log should indicate that the DIRECT sampling algorithm is being executed. The key verifiable outcome, from the user's perspective, is the number of structures that are ultimately passed to the `LabellingEngine`. The user will check the logs or the database to confirm that this number precisely matches the `sample_count` in the configuration file (20 in the example), and that it is significantly smaller than the total number of frames generated by the MD simulation (5,000). A successful test run will show the pipeline completing the entire workflow and producing a final MLIP model, but with the resource-intensive QE `LabellingEngine` being called only a small, fixed number of times. This confirms that the core value proposition of Cycle 03—intelligent data filtering to save computational cost—is being delivered correctly.

---

### **Scenario UAT-C03-02: Verification of Descriptor and Sampling Logic**

**Description (Min 300 words):**
This scenario is designed to provide confidence in the *correctness* of the underlying DIRECT sampling algorithm. While the previous test verifies that filtering *happens*, this test aims to verify that the filtering is *intelligent* and driven by structural diversity. The user will set up a more controlled experiment to test the behavior of the sampler under different conditions. For instance, they could prepare two separate, pre-generated MD trajectories. The first trajectory (Trajectory A) is generated for a perfect crystal structure at a very low temperature, resulting in thousands of frames that are all very similar, containing only minor atomic vibrations. The second trajectory (Trajectory B) is generated for the same material but at a very high temperature, close to its melting point, resulting in a trajectory that contains a wide variety of distorted, disordered, and even liquid-like configurations.

The expectation is that when the user runs the DIRECT sampling algorithm on the low-temperature trajectory (Trajectory A), the algorithm will recognize that all the frames are very similar (i.e., they fall into a single large cluster in the descriptor space) and will correctly select only a few, non-redundant representatives. Conversely, when the same sampling algorithm is run on the high-temperature trajectory (Trajectory B), it should identify multiple distinct clusters of structures (e.g., solid-like, liquid-like, transitional states). The selected samples should be drawn from all of these different clusters, demonstrating the algorithm's ability to capture the full diversity of the explored phase space. The user can verify this by visually inspecting the selected structures or by analyzing the distribution of their potential energies. A successful test shows that the sampler doesn't just pick frames randomly but actively selects for structural diversity, which is the key to building a robust and transferable MLIP. This confirms the scientific validity of the sampling method.

---

## 2. Behavior Definitions

**Scenario: UAT-C03-01 - Successful Filtering of Structures via MACE MD**

```gherkin
GIVEN a user has a minimal 'input.yaml' for Silicon.
AND the configuration has been updated to include a specific 'explorer' section:
  """
  explorer:
    md_steps: 1000
    sample_count: 20
  """
AND the system has been configured to use the pre-trained 'mace_mp_0' model as the surrogate.
WHEN the user executes the full pipeline command `mlip-pipe run --config input.yaml`.
THEN the system should first log the successful expansion of the configuration and the generation of a small number of initial seed structures (e.g., 5).
AND the Explorer & Sampler module should be invoked and log that it is starting the MACE MD simulations.
AND it should run 5 separate MD simulations, each for 1000 steps, for a total of 5000 candidate frames.
AND after the MD runs, the system should log that it is starting the DIRECT sampling algorithm on all 5000 frames.
AND after sampling, the system should log that exactly 20 structures were selected for DFT labelling.
AND the Labelling Engine should subsequently be invoked, and its progress bar or logs should indicate that it is processing exactly 20 structures.
AND the pipeline should complete successfully and create a final 'model.ace' file.
```

---

**Scenario: UAT-C03-02 - Verification of Descriptor and Sampling Logic**

```gherkin
GIVEN a user has two pre-generated ASE trajectory files for an Aluminum crystal, 'traj_low_T.traj' and 'traj_high_T.traj'.
AND Trajectory A ('traj_low_T.traj') was generated at 100 K and contains only minor atomic vibrations around the equilibrium FCC structure.
AND Trajectory B ('traj_high_T.traj') was generated at 1200 K (near melting) and contains both solid-like and highly disordered, liquid-like frames.
AND the user runs a standalone script that invokes the DIRECT sampling algorithm on Trajectory A, configured to select 10 samples.
WHEN the algorithm completes.
THEN all 10 selected structures, when visualized, should appear as nearly perfect crystals with only small atomic displacements.
AND a histogram of the potential energies of the 10 samples should show a very narrow distribution.

GIVEN the user now runs the same script on Trajectory B, also configured to select 10 samples.
WHEN the algorithm completes.
THEN the 10 selected structures, when visualized, should be highly diverse, including some that are clearly crystalline and others that are amorphous or liquid-like.
AND a histogram of the potential energies of these 10 samples should show a broad distribution, spanning the range from the stable solid to the higher-energy liquid states.
```

---

**Scenario: UAT-C03-03 - Performance of Descriptor Calculation Step**

```gherkin
GIVEN a user has a single, large pre-generated MD trajectory file containing 1,000,000 frames of a 108-atom Silicon cell.
WHEN the user runs a script that specifically invokes the descriptor calculation step of the `ExplorerSampler` on this trajectory.
THEN the process should log a message indicating that it is using a Numba JIT-compiled kernel for acceleration.
AND the calculation for all 1,000,000 frames should complete in a reasonable amount of wall-clock time (e.g., under 15 minutes on a standard modern multi-core CPU).
AND during the calculation, the process should not consume an excessive amount of system memory (e.g., it should not crash on a machine with 32 GB of RAM).
```
