# CYCLE 04: SPEC.md

## 1. Summary

This document provides the detailed technical specifications for Cycle 04 of the Autonomous Development Environment (AC-CDD) project. The primary focus of this cycle is to integrate the Auditor and QA Analyst agents into the development workflow. This will introduce the automated quality assurance and code review capabilities that are central to the AC-CDD philosophy. The Auditor agents will be responsible for performing static analysis on the code generated by the Coder agent, checking for compliance with coding standards, best practices, and potential security vulnerabilities. The QA Analyst agent will be responsible for executing the User Acceptance Tests (UATs) defined in the cycle's `UAT.md` file, verifying that the implemented features meet the user's requirements.

This cycle will extend the `run-cycle` command to include these new quality assurance steps. After the Coder agent has successfully generated and tested the code, the Orchestration Engine will invoke the Auditor and QA Analyst agents to perform their respective checks. The successful completion of this cycle will result in a development pipeline with a robust, multi-layered quality gate, ensuring that only code that is both technically sound and functionally correct is accepted.

The implementation will involve creating new agent classes for the Auditor and QA Analyst, as well as extending the orchestration logic to incorporate them into the `run-cycle` workflow. Fast and efficient LLMs, such as Gemini Flash, will be used to power the Auditor agents, while the QA Analyst will interact with the E2B sandbox to execute the UATs. By the end of this cycle, the AC-CDD system will be capable of not only writing and testing code but also of performing sophisticated, AI-powered quality assurance.

## 2. System Architecture

The system architecture for Cycle 04 introduces the Auditor and QA Analyst agents and integrates them into the existing orchestration flow.

The new and updated components are:

*   **Orchestration Engine:** The orchestration logic within the `CoderService` will be extended to invoke the Auditor and QA Analyst agents after the initial unit tests have passed.

*   **Auditor Agent:** A new agent class will be created for the Auditor. This agent will be responsible for reviewing the code generated by the Coder agent. It will be powered by a fast and efficient LLM.

*   **QA Analyst Agent:** This new agent will be responsible for executing the UATs. It will interact with the E2B sandbox to run the acceptance tests and will then parse the results to determine whether the UATs have passed or failed.

*   **LLM API Client:** A new client may be required to interact with the LLMs that will power the Auditor agents (e.g., Gemini).

The updated workflow for the `run-cycle` command is as follows:
1. The Coder agent generates the code and unit tests.
2. The unit tests are run in the E2B sandbox.
3. If the unit tests pass, the Orchestration Engine invokes the Auditor agents to review the code.
4. If the code passes the audit, the Orchestration Engine invokes the QA Analyst agent to run the UATs.
5. If the UATs pass, the cycle is considered complete.

## 3. Design Architecture

The design architecture for Cycle 04 focuses on adding the new agent classes and extending the orchestration logic in a clean and modular way.

**File Structure:**

The following new and updated files will be created within `dev_src/ac_cdd_core/`:

*   `services/coder.py`: The `CoderService` will be updated to include the orchestration logic for the new agents.
*   `agents/auditor.py`: A new file for the `AuditorAgent` class.
*   `agents/qa_analyst.py`: A new file for the `QaAnalystAgent` class.
*   `clients/gemini.py`: A new file for a `GeminiApiClient`, if required.

**Class and Function Definitions:**

*   **`services/coder.py`:**
    *   `CoderService.run()`: The `run` method will be extended to include calls to the `AuditorAgent` and `QaAnalystAgent`.

*   **`agents/auditor.py`:**
    *   `class AuditorAgent:`:
        *   `def __init__(self, api_client):`: The constructor will take an appropriate API client.
        *   `def audit_code(self, code):`: This method will take the code as a string, send it to the LLM for review, and return a list of any identified issues.

*   **`agents/qa_analyst.py`:**
    *   `class QaAnalystAgent:`:
        *   `def __init__(self, sandbox_service):`: The constructor will take an instance of the `E2bSandboxService`.
        *   `def run_uats(self, cycle_id):`: This method will execute the UATs for the given cycle in the sandbox and return the results.

This design ensures that the new quality assurance functionality is encapsulated within dedicated agent classes, keeping the orchestration logic in the `CoderService` clean and easy to understand.

## 4. Implementation Approach

The implementation of Cycle 04 will be carried out in the following steps:

1.  **Implement `AuditorAgent`:** The `AuditorAgent` class will be implemented in `agents/auditor.py`. This will involve integrating with the chosen LLM API for code analysis.

2.  **Implement `QaAnalystAgent`:** The `QaAnalystAgent` class will be created in `agents/qa_analyst.py`. This will involve implementing the logic for executing the UATs in the E2B sandbox and parsing the results.

3.  **Update `CoderService`:** The `CoderService` will be updated to include the new orchestration logic for invoking the Auditor and QA Analyst agents.

4.  **Write unit tests:** Comprehensive unit tests will be written for the new agent classes. The LLM APIs and the E2B sandbox will be mocked.

5.  **Write integration tests:** Integration tests for the `run-cycle` command will be extended to cover the new quality assurance steps. These tests will use mocked responses from the Auditor and QA Analyst agents to verify the orchestration logic.

## 5. Test Strategy

The test strategy for Cycle 04 will focus on ensuring the correctness of the new quality assurance agents and their integration into the development workflow.

**Unit Testing Approach:**

*   **`AuditorAgent`:** The unit tests will verify that the agent correctly formats the prompt for the LLM and that it correctly parses the response to extract any identified issues. The LLM API will be mocked.

*   **`QaAnalystAgent`:** The tests will verify that the agent correctly executes the UATs in the sandbox and that it correctly parses the test results. The `E2bSandboxService` will be mocked.

**Integration Testing Approach:**

The integration tests for the `run-cycle` command will be extended to cover the following scenarios:

*   **Successful QA:** A test where the code passes both the audit and the UATs. The test will verify that the `run-cycle` command completes successfully.

*   **Audit Failure:** A test where the Auditor agent reports issues with the code. The test will mock the `AuditorAgent` to return a list of issues and will verify that the `run-cycle` command exits with an appropriate error message.

*   **UAT Failure:** A test where the QA Analyst agent reports that the UATs have failed. The test will mock the `QaAnalystAgent` to return a failing result and will verify that the `run-cycle` command exits with an appropriate error message.
